<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TruckEase - Driver Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f4f6fc; padding: 15px; }
        .header { background: #2854ff; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { font-size: 20px; }
        #driverInfo { font-size: 14px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; }
        .btn-login { background: white; color: #2854ff; border: none; padding: 8px 15px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        .btn-accept { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        .booking-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #2854ff; }
        .booking-card.pending { border-left-color: #ff9800; }
        .booking-card h4 { font-size: 16px; margin-bottom: 8px; }
        .booking-card p { font-size: 14px; color: #666; margin: 5px 0; }
        .status { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.accepted { background: #d4edda; color: #155724; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 90%; max-width: 350px; }
        .modal-content input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
        .btn-main { background: #2854ff; color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; margin-top: 10px; cursor: pointer; }
        #recaptcha-container { margin: 10px 0; }
        .error { color: red; font-size: 12px; margin-top: 5px; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center;">üöõ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§≤‡•â‡§ó‡§ø‡§®</h3>
            <div id="phoneSection">
                <input type="tel" id="phoneNumber" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (10 ‡§Ö‡§Ç‡§ï)" maxlength="10">
                <div id="recaptcha-container"></div>
                <button class="btn-main" id="sendOtpBtn">OTP ‡§≠‡•á‡§ú‡•á‡§Ç</button>
            </div>
            <div id="otpSection" style="display:none;">
                <input type="text" id="otpCode" placeholder="OTP ‡§°‡§æ‡§≤‡•á‡§Ç">
                <button class="btn-main" id="verifyOtpBtn">‡§µ‡•á‡§∞‡§ø‡§´‡§æ‡§à ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
            <p id="loginError" class="error"></p>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h2>üöõ Driver Panel</h2>
        <div id="driverInfo">
            <span id="driverStatus">‡§≤‡•â‡§ó‡§ø‡§® ‡§®‡§π‡•Ä‡§Ç</span>
            <button class="btn-login" id="loginBtn" onclick="showLoginModal()">‡§≤‡•â‡§ó‡§ø‡§®</button>
        </div>
    </div>

    <!-- Pending Bookings List -->
    <div id="bookingsList">
        <div style="text-align:center; padding:20px;">‚è≥ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç...</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config (same as before)
        const firebaseConfig = {
            apiKey: "AIzaSyByh4tT4zcUpjjQ_ebaYzpSulGtsDHjbw0",
            authDomain: "truckease-cb961.firebaseapp.com",
            projectId: "truckease-cb961",
            storageBucket: "truckease-cb961.firebasestorage.app",
            messagingSenderId: "558046020925",
            appId: "1:558046020925:web:573533af4bbf93841e3154"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentDriver = null;
        let recaptchaVerifier;

        // Check if already logged in
        auth.onAuthStateChanged(user => {
            if (user) {
                currentDriver = user;
                document.getElementById('driverStatus').innerText = user.phoneNumber;
                document.getElementById('loginBtn').innerText = '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü';
                loadPendingBookings();
            } else {
                currentDriver = null;
                document.getElementById('driverStatus').innerText = '‡§≤‡•â‡§ó‡§ø‡§® ‡§®‡§π‡•Ä‡§Ç';
                document.getElementById('loginBtn').innerText = '‡§≤‡•â‡§ó‡§ø‡§®';
                document.getElementById('bookingsList').innerHTML = '<div class="empty-state">üë§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</div>';
            }
        });

        // Login Modal Functions
        window.showLoginModal = function() {
            if (currentDriver) {
                // Logout
                auth.signOut();
                return;
            }
            document.getElementById('loginModal').classList.add('active');
            if (!recaptchaVerifier) {
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    size: 'invisible',
                    callback: () => {}
                });
            }
        };

        document.getElementById('sendOtpBtn')?.addEventListener('click', async () => {
            const phone = document.getElementById('phoneNumber').value;
            if (!phone || phone.length !== 10) {
                document.getElementById('loginError').innerText = '‡§∏‡§π‡•Ä 10 ‡§Ö‡§Ç‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç';
                return;
            }
            try {
                const confirmationResult = await auth.signInWithPhoneNumber('+91' + phone, recaptchaVerifier);
                window.confirmationResult = confirmationResult;
                document.getElementById('phoneSection').style.display = 'none';
                document.getElementById('otpSection').style.display = 'block';
                document.getElementById('loginError').innerText = '';
            } catch (error) {
                document.getElementById('loginError').innerText = 'OTP ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§æ: ' + error.message;
            }
        });

        document.getElementById('verifyOtpBtn')?.addEventListener('click', async () => {
            const otp = document.getElementById('otpCode').value;
            if (!otp) return;
            try {
                await window.confirmationResult.confirm(otp);
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('phoneSection').style.display = 'block';
                document.getElementById('otpSection').style.display = 'none';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('otpCode').value = '';
            } catch (error) {
                document.getElementById('loginError').innerText = 'OTP ‡§ó‡§≤‡§§ ‡§π‡•à';
            }
        });

        // Close modal if clicked outside
        document.getElementById('loginModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });

        // Load all pending bookings
        async function loadPendingBookings() {
            if (!currentDriver) return;

            try {
                const snapshot = await db.collection('bookings')
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'desc')
                    .get();

                if (snapshot.empty) {
                    document.getElementById('bookingsList').innerHTML = '<div class="empty-state">üì≠ ‡§ï‡•ã‡§à ‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const b = doc.data();
                    const id = doc.id;
                    const time = b.timestamp ? new Date(b.timestamp.toDate()).toLocaleString('hi-IN') : '‡§Ö‡§≠‡•Ä-‡§Ö‡§≠‡•Ä';
                    
                    html += `
                        <div class="booking-card pending" data-id="${id}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h4>${b.vehicle || '‡§ó‡§æ‡§°‡§º‡•Ä'}</h4>
                                <span class="status pending">‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó</span>
                            </div>
                            <p><strong>üìç ‡§™‡§ø‡§ï‡§Ö‡§™:</strong> ${b.pickup}</p>
                            <p><strong>üéØ ‡§°‡•ç‡§∞‡•â‡§™:</strong> ${b.drop}</p>
                            <p><strong>üìè ‡§¶‡•Ç‡§∞‡•Ä:</strong> ${b.km || 0} km</p>
                            <p><strong>üí∞ ‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ:</strong> ‚Çπ${b.fare} (‡§Ü‡§™‡§ï‡•ã ‚Çπ${b.driverAmount} ‡§Æ‡§ø‡§≤‡•á‡§Ç‡§ó‡•á)</p>
                            <p style="font-size:12px; color:#999;">‚è∞ ${time}</p>
                            <button class="btn-accept" onclick="acceptBooking('${id}')">‚úÖ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                    `;
                });
                document.getElementById('bookingsList').innerHTML = html;
            } catch (error) {
                document.getElementById('bookingsList').innerHTML = '<div class="error">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü</div>';
                console.error(error);
            }
        }

        // Accept booking function
        window.acceptBooking = async function(bookingId) {
            if (!currentDriver) {
                alert('‡§™‡§π‡§≤‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç');
                return;
            }

            if (!confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ï‡•ã ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) return;

            try {
                await db.collection('bookings').doc(bookingId).update({
                    status: 'accepted',
                    driverId: currentDriver.uid,
                    driverPhone: currentDriver.phoneNumber,
                    acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞ ‡§≤‡•Ä ‡§ó‡§à!');
                loadPendingBookings(); // Refresh list
            } catch (error) {
                alert('‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§™‡§æ‡§è: ' + error.message);
            }
        };

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (currentDriver) loadPendingBookings();
        }, 30000);
    </script>
</body>
  </html>
